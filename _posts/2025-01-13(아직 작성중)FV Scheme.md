---
title: FV Scheme
categories: [암호학, 동형암호]
tags: [FV, FHE, SHE]
pin: false
math: true
mermaid: true

---

## 서론

본 포스팅에서는 **SHE(Somewhat Practical Fully Homomorphic Encryption)** 을 만족하는 **FV Scheme** 에 대해 설명 하고, 이러한 **FV Scheme** 을 어떻게 **FHE(Fully Homomorphic Encryption** 으로 전환 할 수 있는 지 설명 하도록 하겠습니다.

## Basic Notation

$$
\begin{equation}
R= \mathbb{Z}[x]/(f(x)),\;f(x)∈\mathbb{Z}[x]\nonumber
\end{equation}
$$



기본적으로 FV 는 **RLWE** 기반으로 동작합니다. 즉, **다항식 Ring** 위에서 동작합니다.


$$
\begin{equation}
f(x) = x^d + 1 \quad with \quad d= 2^n \nonumber
\end{equation}
$$



일반적으로 *f(x)* 는 **cyclotomic polynomial** 으로 설정하고, *d* 는 위와 같이 설정합니다. 이렇게 설정하는 이유는 다항식 연산 시 계산 복잡도를 줄일 수 있기 때문입니다.


$$
\begin{equation}
  \mathbf{a} ∈R ,\quad \mathbf{a}=\sum_{i=0}^{d-1}a_i \cdot x^i\nonumber
\end{equation}
$$



**R** 의 원소는 이 굵은 소문자로 표시합니다.

$$
\begin{gather}
||\mathbf{a}||\;\; is\;defined\;as\;\; max_i|a_i|\nonumber\\
δ_R = max\{||\mathbf{a}·\mathbf{b}||/(||\mathbf{a}||·||\mathbf{b}||):\mathbf{a},\mathbf{b} ∈R\}\nonumber
\end{gather}
$$



\|\|**a**\|\| 은 다항식 **a** 가 가질 수 있는 가장 큰 계수를 나타냅니다. 그리고 `δR` 은 곱셈 연산으로 인해 다항식의 크기가 얼마나 증가하는 지 나타내는 **확장 계수**를 의미 합니다. 예를 들어 보겠습니다.


$$
\begin{gather}
\mathbf{a} = 1+2x+x^2,\;\mathbf{b} = 1+3x+x^2,\;\mathbf{ab}=1+5x+8x^2+5x^3+x^4 \nonumber\\
δ_R = max\{||\mathbf{a}·\mathbf{b}||/(||\mathbf{a}||·||\mathbf{b}||)\} = \frac{8}6\nonumber
\end{gather}
$$



이러한 확장 계수는 추후 노이즈의 범위를 정의하는 데 사용됩니다.



$$
\begin{gather}
\mathbb{Z}_q : the\;set\;of\;integers\;(-q/2,q/2],\;q>1\;be\;an\;integer\;
(not\;be\;confused\;with\;the\;ring\;\mathbb{Z}/q\mathbb{Z})\nonumber\\
\mathbf{R}_q : the\;set\;of\;polynomials\;in\;\mathbf{R}\;with\;coefficients\;in\;\mathbb{Z_q}\nonumber
\end{gather}
$$



위 식은 다항식 계수가 가질 수 있는 값의 범위를 제한합니다.




$$
\begin{gather}
	χ\text{ is Gaussian distribution on }\mathbf{R}\nonumber\\
	\text{A distribution }χ \text{ is called B-bounded if it is supported on [−B,B]}\nonumber
\end{gather}
$$



$f(x) = x^d+1,\;d=2^k$ 인 $f(x)$ 를 사용할 때, $χ$ 는 가우시안 분포를 따른다고 합니다. 그리고 **B** 는 $χ$ 의 범위를 나타낼 때 쓰입니다.  조금 어려운 설명인데, 다음 두 가지만 이해 하시면 됩니다.

1. $χ$ 는 랜덤한 다항식을 추출할 때 사용된다.
2. **B** 는 노이즈가 최대로 가질 수 있는 범위를 설정할 때 사용된다.

$χ$ 와 **B** 는 자주 등장하니 그 때 다시 한 번 설명 하겠습니다.



$$
\begin{gather}
[\mathbf{a}]_q:\text{다항식 a 의 계수에 mod q 를 한 결과}\nonumber\\
r_q(a):remainder\;modulo\;q\nonumber\\
⌊x⌉:\text{반올림},\;x ∈\mathbb{R}\nonumber\\
⌊x⌋:\text{버림},\;x ∈\mathbb{R}\nonumber\\
⌈x⌉:\text{올림},\;x ∈\mathbb{R}\nonumber\\
size(n)=⌈log_2(n+ 0.5)⌉(bit\;size)\nonumber
\end{gather}
$$



마지막으로 자주 사용되는 정의들을 정리 해두었습니다.



## RLWE Problem

### **Definition 1. (Decision-RLWE)**

> 보안 매개 변수 λ 에 대해,  $deg(f) = φ(m),\;f(x)\text{ : cyclotomic polynomial}$ , $R= Z[x]/(f(x))$ 라 하자. 또한  $Q= q(λ) ≥2$ , $s ∈R_q$ , $R$ 위의 분포 $χ= χ(λ)$ 에 대해 균일 무작위 요소 $a ←R_q$ 와 노이즈 항 $e ←χ$ 및 출력  $(a,[a\cdot s+e]_q)$ 을 선택하여 얻은 분포를 $A(q) _{s,χ}^q$ 라 하자. $Decision-RLWE _{d,q,χ}$ 은 분포 $A(q) _{s,χ}^{(q)}$ 와 균일 분포 $U(R^2_q)$ 를 구별하는 문제이다.
{: .prompt-tip }

결론적으로 $(a,[a \cdot s + e] _q)$ 를 생성하는 $A(q) _{s,χ}^{(q)}$ 와 랜덤한 균일 출력 $U(R^2_q)$ 을 구분할 수 없어야 합니다. 이를 전제로 앞으로의 설명을 진행 하겠습니다. 그리고 $s←R_q$ 대신 $s←χ$ 을 사용해도 보안 상에 문제가 없기에 $s$ 는 노이즈 분포인 $χ$ 에서 추출 한다고 합니다. 마지막으로 $q$ 는 꼭 소수일 필요 없이 2의 거듭제곱 형태로 나타낼 수 있으면 됩니다.

## Encryption Scheme

> $∆ = ⌊q/t⌋$ , $r _t(q)=\text{q mod t}$ ,  $t>1$ 일 때 $q=∆\cdot t + r _t(q)$ 이고 $LPR.ES$ 는 다음과 같다.
{: .prompt-tip}

$LPR.ES.SecretKeyGen(1^\lambda)$

: $s ←χ$ 을 샘플링 후 $sk= s$ 출력

$LPR.ES.PublicKeyGen(sk)$

: $s = sk$ 라 하고, $a ←R _q$, $e ←χ$  를 샘플링 후 $pk = ([−(a·s + e)] _q,\;a)$ 출력

$LPR.ES.Encrypt(pk,m)$ 

: $m ∈R_t$ 인 메시지를 암호화, $p_0 = pk[0]$, $p_1 = pk[1]$ 라 할 때 $u,e1,e2 ←χ$ 을 샘플링 하여 $ct = ([p_0·u + e1 + ∆·m]_q,\;[p_1·u + e2]_q)$ 출력

$LPR.ES.Decrypt(sk,ct)$

: $s = sk, \;c_0 = ct[0], \;c_1 = ct[1]$ 일 때 $\left[\left\lfloor
\frac{t \cdot [c_0+c_1 \cdot s]_q}{q} 
\right\rceil\right]_t$

위의 Encryption 과정을 거친 후 최종적으로 Decryption 이 제대로 동작하는 지 확인하기 위해서는 다음의 lemma 를 증명하면 됩니다.

### **Lemma 1.** 

> $LPR.ES$ 을 사용하고 
> $\eqref{eq:number1}$ 에서
> ${||\chi|| < B}$ ,
> ${||\mathbf{v}|| \leq 2 \cdot \delta _R \cdot B^2 + B}$ 일 때,
>
> $2\cdot\delta _R\cdot B^2 + B < \Delta/2$ 이면 올바른 복호화가 이루어진다.
{: .prompt-tip}

$$
\begin{equation}
[\mathbf{c}_0+\mathbf{c}_1 \cdot s] _q = \Delta \cdot \mathbf{m} + \mathbf{v}\label{eq:number1}
\end{equation}
$$

**Lemma 1** 에 따르면 $2\cdot\delta _R\cdot B^2 + B < \Delta/2$  를 만족할 때 decryption 이 제대로 동작하게 됩니다. 이제 이를 증명하겠습니다.

#### **Proof**


$$
\begin{align}
\mathbf{c}_0+\mathbf{c}_1 \cdot \mathbf{s} &= \mathbf{p}_0 \cdot \mathbf{u} + \mathbf{e}_1 + \Delta \cdot \mathbf{m} + \mathbf{p}_1 \cdot \mathbf{u} \cdot \mathbf{s} + \mathbf{e}_2 \cdot \mathbf{s} \; mod \; q \; \nonumber\\
&= \Delta \cdot \mathbf{m} + \mathbf{e} \cdot \mathbf{u} \cdot + \mathbf{e}_1 + \mathbf{e}_2 \cdot \mathbf{s} \;mod \;q \nonumber
\end{align}
$$



$\Delta \cdot \mathbf{m} + \mathbf{e} \cdot \mathbf{u} \cdot + \mathbf{e}_1 + \mathbf{e}_2 \cdot \mathbf{s}$ 는 $R_q$ 에 속하는 다항식 이므로
$\mathbf{v}=\mathbf{e} \cdot \mathbf{u} + \mathbf{e}_1 + \mathbf{e}_2 \cdot \mathbf{s}$ 라 정의할 수 있고, 
$\mathbf{e},\mathbf{e}_1,\mathbf{e}_2,\mathbf{u},\mathbf{s} ← \chi$ 이므로 
${||\mathbf{v}|| \leq 2 \cdot \delta _R \cdot B^2 + B}$ 가 됩니다. 다시 한 번 언급하자면
 $\delta_R$ 은 확장 계수로, 곱셈 시 어느 정도의 비율로 계수가 커지는 지를 나타냅니다. B 는 다항식 $\chi$ 를 샘플링하는 범위로, 나올 수 있는 계수의 최댓값 이라고 이해하시면 됩니다.
즉, $\mathbf{e} \cdot \mathbf{u} \text{ and } \mathbf{e}_2 \cdot \mathbf{s} \le \delta_R \cdot B \; , \; \mathbf{e}_1 \le B$ 이므로 $\mathbf{v}$ 의 최대 크기는 위와 같이 정의할 수 있습니다. 확장 계수를 이용하여 범위를 나타내는 방식은 뒤에도 계속 등장합니다.

이제 decryption 식에 $[\mathbf{c}_0+\mathbf{c}_1 \cdot s] _q = \Delta \cdot \mathbf{m} + \mathbf{v}$ 를 대입 해보겠습니다.




$$
\left[\left\lfloor \frac{t \cdot (\Delta \cdot \mathbf{m} + \mathbf{v})}{q}  \right\rceil\right]_t\nonumber
$$


식을 조금 더 정리 해보겠습니다.


$$
\begin{equation}
\left\lfloor\frac{t \cdot (\Delta \cdot \mathbf{m} + \mathbf{v})}{q}\right\rceil = \left\lfloor\mathbf{m} + \frac{t \cdot \mathbf{v}}q\right\rceil\label{eq:number2}
\end{equation}
$$

decryption 이 올바르게 동작한다면 $ \eqref{eq:number2}$ 의 결과는 $\mathbf{m}$ 이 되어야 하고, $\mathbf{m}$ 이 나오기 위해서는
$\frac{t}q||\mathbf{v}||<1/2$  이 되어야 합니다. 따라서 다음 식을 만족합니다.


$$
\begin{align}
||\mathbf{v}||<\frac{\Delta}2<\frac{q}{2 \cdot t}\;,\quad {||\mathbf{v}|| \leq 2 \cdot \delta _R \cdot B^2 + B} < \frac{\Delta}2\label{eq:num3}
\end{align}
$$


$\Delta=\left\lfloor\frac{q}t\right\rfloor<\frac{q}t$ 이므로 $\eqref{eq:num3}$ 을 만족합니다. 따라서 **Lemma 1** 을 증명 완료 합니다.
